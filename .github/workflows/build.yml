name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

# 定义全局变量，方便修改应用名称
env:
  APP_NAME: "AudioQC" # 你的可执行文件将以此命名，例如 AudioQC.exe

jobs:
  build:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            TARGET: linux
            # Linux下生成 tar.gz
            ARCHIVE_EXT: tar.gz
          - os: macos-latest
            TARGET: macos
            # Mac下生成 zip
            ARCHIVE_EXT: zip
          - os: windows-latest
            TARGET: windows
            # Windows下生成 zip
            ARCHIVE_EXT: zip

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      # 1. 获取版本号 (去掉 refs/tags/v 前缀，例如 v1.0.0 -> 1.0.0)
      # 如果是手动触发(workflow_dispatch)，默认为 snapshot
      - name: Get Version
        shell: bash
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="snapshot"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Version detected: $VERSION"

      # 1.5 获取架构 (x64, arm64)
      - name: Get Architecture
        shell: bash
        run: |
          PYTHON_ARCH=$(python -c "import platform; print(platform.machine().lower())")
          if [[ "$PYTHON_ARCH" == "amd64" ]] || [[ "$PYTHON_ARCH" == "x86_64" ]]; then
            ARCH="x64"
          elif [[ "$PYTHON_ARCH" == "arm64" ]] || [[ "$PYTHON_ARCH" == "aarch64" ]]; then
            ARCH="arm64"
          else
            ARCH=$PYTHON_ARCH
          fi
          echo "ARCH=$ARCH" >> $GITHUB_ENV
          echo "Architecture detected: $ARCH"

      # 2. PyInstaller 打包
      # 注意：这里使用 env.APP_NAME 统一命名
      - name: Build with PyInstaller
        run: |
          pyinstaller -F -w -n ${{ env.APP_NAME }} main.py

      # 3. 整理文件并打包 (Windows)
      - name: Package for Windows
        if: matrix.os == 'windows-latest'
        run: |
          # 定义最终包的目录名，如 AudioQC-1.0.0-windows-x64
          $RELEASE_DIR = "${{ env.APP_NAME }}-${{ env.VERSION }}-${{ matrix.TARGET }}-${{ env.ARCH }}"
          New-Item -ItemType Directory -Force -Path $RELEASE_DIR
          
          # 移动可执行文件到目录中
          Move-Item -Path "dist\${{ env.APP_NAME }}.exe" -Destination $RELEASE_DIR\
          
          # 复制 asset 文件夹
          Copy-Item -Path "asset" -Destination $RELEASE_DIR\ -Recurse
          
          # (可选) 如果你有 README 或 默认配置文件，也可以在这里复制进去
          # Copy-Item "README.md" -Destination $RELEASE_DIR\
          
          # 压缩该目录
          Compress-Archive -Path $RELEASE_DIR -DestinationPath "${RELEASE_DIR}.zip"

      # 3. 整理文件并打包 (Linux/Mac)
      - name: Package for Unix
        if: matrix.os != 'windows-latest'
        run: |
          # 定义最终包的目录名
          RELEASE_DIR="${{ env.APP_NAME }}-${{ env.VERSION }}-${{ matrix.TARGET }}-${{ env.ARCH }}"
          mkdir -p "$RELEASE_DIR"
          
          # 移动构建产物
          if [ "${{ matrix.os }}" == "macos-latest" ]; then
            # Mac 移动 .app 包
            mv "dist/${{ env.APP_NAME }}.app" "$RELEASE_DIR/"
          else
            # Linux 移动二进制文件
            mv "dist/${{ env.APP_NAME }}" "$RELEASE_DIR/"
          fi
          
          # 复制 asset 文件夹
          cp -r asset "$RELEASE_DIR/"
          
          # (可选) 复制 README 等
          # cp README.md "$RELEASE_DIR/"
          
          # 压缩
          if [ "${{ matrix.TARGET }}" == "linux" ]; then
            tar -czvf "${RELEASE_DIR}.tar.gz" "$RELEASE_DIR"
          else
            zip -r "${RELEASE_DIR}.zip" "$RELEASE_DIR"
          fi

      # 4. 上传 Release
      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            ${{ env.APP_NAME }}-${{ env.VERSION }}-${{ matrix.TARGET }}-${{ env.ARCH }}.${{ matrix.ARCHIVE_EXT }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}