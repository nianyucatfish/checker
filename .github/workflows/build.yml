name: Build and Release

# 触发条件：当你推送类似 'v1.0.0' 的标签时触发，或者手动触发
on:
  push:
    tags:
      - 'v*' 
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build packages
    # 矩阵策略：同时在三个平台上运行
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            TARGET: linux
            CMD_BUILD: pyinstaller -F -w -n MyApp main.py
            OUT_FILE_NAME: MyApp
            ASSET_MIME: application/x-executable
          - os: macos-latest
            TARGET: macos
            CMD_BUILD: pyinstaller -F -w -n MyApp main.py
            OUT_FILE_NAME: MyApp.app # Mac通常打包成.app，如果是单文件则是名字
            ASSET_MIME: application/zip
          - os: windows-latest
            TARGET: windows
            CMD_BUILD: pyinstaller -F -w -n MyApp main.py
            OUT_FILE_NAME: MyApp.exe
            ASSET_MIME: application/vnd.microsoft.portable-executable

    steps:
    # 1. 拉取代码
    - uses: actions/checkout@v4

    # 2. 设置 Python 环境
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10' # 根据你的项目修改版本

    # 3. 安装依赖
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    # 4. 执行打包 (PyInstaller)
    - name: Build with PyInstaller
      run: ${{ matrix.CMD_BUILD }}

    # 5. 处理 Mac 的特殊情况 (如果是 .app 文件夹，需要压缩)
    - name: Zip Mac App
      if: matrix.os == 'macos-latest'
      run: |
        cd dist
        zip -r MyApp-macos.zip MyApp.app

    # 6. 上传 Artifact (用于 Release)
    - name: Upload Release Asset
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          dist/${{ matrix.OUT_FILE_NAME }}
          dist/MyApp-macos.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
